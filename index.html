<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <title>ZubrLite ‚Äî —á–∞—Ç, –ø–æ–∏—Å–∫, –ø–µ—Ä–µ–≤–æ–¥ –∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä</title>
  <style>
    :root {
      --blue: #0066cc;
      --blue-light: #4dd0e1;
      --blue-deep: #0057a3;
      --border: #a0dcdc;
      --bg: #e0f7f7;
      --text: #004d40;
    }
    body {
      background-color: Lightblue;
      margin: 0;
      font-family: Arial, sans-serif;
      color: var(--text);
    }

    /* –û—Å–Ω–æ–≤–Ω–æ–µ –æ–∫–Ω–æ */
    .chat-window {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 960px;
      height: 820px;
      background-color: var(--bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å */
    .chat-header {
      background-color: var(--blue);
      padding: 10px 12px;
      border-radius: 12px 12px 0 0;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .brand {
      display: flex;
      flex-direction: column;
      line-height: 1.15;
    }
    .brand .title { font-size: 16px; letter-spacing: 0.3px; font-weight: 700; }
    .brand .date { font-size: 12px; opacity: 0.95; }

    .header-controls {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .mode-select {
      appearance: none;
      background: #fff;
      color: var(--blue-deep);
      border: none;
      border-radius: 16px;
      padding: 6px 12px;
      font-weight: bold;
      cursor: pointer;
    }

    .circle-btn {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      background-color: #007bff;
      color: #fff;
      border: none;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s;
    }
    .circle-btn:hover { background-color: #1a86ff; }

    .pill-btn {
      padding: 6px 12px;
      border-radius: 16px;
      border: none;
      cursor: pointer;
      font-weight: 700;
      color: #fff;
      background: #0a68ff;
    }
    .pill-btn:hover { background: #115eff; }

    /* –õ–µ–Ω—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏–π */
    .chat-messages {
      flex: 1;
      padding: 12px;
      overflow-y: auto;
      font-size: 15px;
      background: rgba(255,255,255,0.55);
    }

    /* –í–≤–æ–¥ */
    .chat-input {
      border-top: 1px solid var(--border);
      padding: 10px;
      display: flex;
      gap: 8px;
      background: rgba(255,255,255,0.75);
    }
    .chat-input input {
      flex: 1;
      padding: 8px;
      border: 1px solid var(--border);
      border-radius: 8px;
      outline: none;
      background: #fff;
    }
    .chat-input button {
      background-color: var(--blue-light);
      border: none;
      border-radius: 8px;
      padding: 8px 14px;
      color: white;
      cursor: pointer;
      transition: background-color 0.2s;
      font-weight: bold;
    }
    .chat-input button:hover { background-color: #26c6da; }

    /* PM –∑–∞–≥–æ–ª–æ–≤–æ–∫: –∏–∑—è—â–Ω–∞—è —Ü–∏—Ç–∞—Ç–∞ */
    .pm-title {
      background: #0a68ff;
      color: #fff;
      padding: 10px 12px;
      border-radius: 8px;
      margin: 8px 0;
      font-family: "Georgia", "Times New Roman", serif;
      font-style: italic;
      font-weight: 600;
      border-left: 6px solid #003f99;
      box-shadow: 0 2px 6px rgba(0,60,140,0.25);
      letter-spacing: 0.2px;
    }

    /* –ë–æ–∫–æ–≤—ã–µ –ø–∞–Ω–µ–ª–∏ */
    .side-panel {
      position: absolute;
      right: 0;
      top: 52px;
      width: 520px;
      height: calc(100% - 52px);
      background: #f7fbff;
      border-left: 1px solid var(--border);
      box-shadow: -2px 0 8px rgba(0,0,0,0.08);
      display: none;
      flex-direction: column;
      z-index: 5;
    }
    .side-panel.active { display: flex; }

    .panel-header {
      background: #e6f0ff;
      padding: 8px 10px;
      font-weight: bold;
      color: var(--blue-deep);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .panel-body { flex: 1; overflow: auto; padding: 10px; background: #fff; }
    .panel-footer {
      border-top: 1px solid var(--border);
      padding: 8px 10px;
      background: #fff;
      display: flex;
      gap: 8px;
    }

    /* –ü–æ–∏—Å–∫ */
    .search-form { display: flex; gap: 8px; margin-bottom: 10px; }
    .search-form input {
      flex: 1; padding: 8px; border: 1px solid var(--border); border-radius: 6px;
    }
    .search-form button {
      padding: 8px 12px; border: none; border-radius: 6px; background: var(--blue); color: #fff; cursor: pointer; font-weight: bold;
    }
    .result-link {
      display: block; margin: 6px 0; color: #0057a3; text-decoration: none; font-weight: 600;
    }
    .result-link:hover { text-decoration: underline; }
    .search-frame { width: 100%; height: 360px; border: 1px solid var(--border); border-radius: 6px; background: #fff; }
    .note { font-size: 12px; color: #336; opacity: 0.9; margin-top: 6px; }

    /* –ü–µ—Ä–µ–≤–æ–¥ */
    .translate-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;
    }
    .translate-select, .translate-text {
      width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: #fff;
    }
    .translate-actions { display: flex; gap: 8px; }
    .translate-actions button {
      padding: 8px 12px; border: none; border-radius: 6px; background: var(--blue); color: #fff; cursor: pointer; font-weight: bold;
    }

    /* –†–µ–¥–∞–∫—Ç–æ—Ä */
    .editor-canvas {
      position: relative;
      width: 100%;
      height: 480px;
      border: 1px dashed #a0dcdc;
      border-radius: 8px;
      background: #f9fcff;
      overflow: hidden;
      cursor: default;
    }
    .editor-toolbar { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; margin-bottom: 8px; }
    .editor-toolbar button, .editor-toolbar select, .editor-toolbar input {
      padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: #fff; cursor: pointer;
    }

    .block {
      position: absolute;
      min-width: 120px;
      min-height: 40px;
      border: 1px solid #c7e7ff;
      border-radius: 6px;
      background: #ffffff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      padding: 8px;
      user-select: none;
    }
    .block .handle {
      position: absolute; top: -10px; left: -10px;
      width: 24px; height: 24px; border-radius: 50%;
      background: #0a68ff; color: #fff; font-size: 14px;
      display: flex; align-items: center; justify-content: center; cursor: grab;
      border: 2px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    }
    .block .content[contenteditable="true"] {
      outline: none;
    }
    .block img { max-width: 100%; max-height: 100%; border-radius: 4px; display: block; }

    .font-serif { font-family: "Georgia", "Times New Roman", serif; }
    .font-sans { font-family: Arial, Helvetica, sans-serif; }
    .font-mono { font-family: "Courier New", Courier, monospace; }
    .font-roboto { font-family: "Roboto", Arial, sans-serif; }
    .font-playfair { font-family: "Playfair Display", Georgia, serif; }
    .font-oswald { font-family: "Oswald", Arial, sans-serif; }

    /* Cookie Consent Modal */
    #cookieModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    #cookieModal.hidden {
      display: none;
    }
    .modal-content {
      background-color: var(--bg);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid var(--border);
      max-width: 400px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .modal-content h2 {
      margin-top: 0;
      color: var(--text);
    }
    .consent-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 15px;
    }
    .consent-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      min-width: 80px;
    }
    .consent-yes {
      background-color: var(--blue-light);
      color: white;
    }
    .consent-no {
      background-color: #ff6b6b;
      color: white;
    }
    .consent-btn:hover {
      opacity: 0.8;
    }
  </style>
</head>
<body>
  <div class="chat-window">
    <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å -->
    <div class="chat-header">
      <div class="brand">
        <span class="title">–ß–∞—Ç —Å ZubrLite</span>
        <span class="date">–°–µ–≥–æ–¥–Ω—è: <span id="today"></span></span>
      </div>
      <div class="header-controls">
        <select id="modeSelect" class="mode-select" title="–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º">
          <option value="standard">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π</option>
          <option value="school">–®–∫–æ–ª—å–Ω—ã–π</option>
          <option value="pro">–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π</option>
        </select>
        <button class="circle-btn" id="searchBtn" title="–ü–æ–∏—Å–∫ –ø–æ –Ø–Ω–¥–µ–∫—Å—É">üîç</button>
        <button class="circle-btn" id="translateBtn" title="–ü–µ—Ä–µ–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞">üåê</button>
        <button class="pill-btn" id="editorBtn" title="–†–µ–¥–∞–∫—Ç–æ—Ä —Ç–µ–∫—Å—Ç–∞">–†–µ–¥–∞–∫—Ç–æ—Ä —Ç–µ–∫—Å—Ç–∞</button>
      </div>
    </div>

    <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
    <div class="chat-messages" id="chatMessages">
    </div>

    <!-- –í–≤–æ–¥ -->
    <div class="chat-input">
      <input type="text" id="userInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ... (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ–≥ &lt;PM –≤–∞—à –∑–∞–≥–æ–ª–æ–≤–æ–∫ PM&gt; –¥–ª—è —Å–∏–Ω–µ–π —Ü–∏—Ç–∞—Ç—ã)">
      <button id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å: –ü–æ–∏—Å–∫ -->
    <div class="side-panel" id="searchPanel">
      <div class="panel-header">
        <span>–ü–æ–∏—Å–∫ (–Ø–Ω–¥–µ–∫—Å)</span>
        <button class="circle-btn" id="closeSearch" title="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
      </div>
      <div class="panel-body">
        <form class="search-form" id="searchForm">
          <input type="text" id="searchQuery" placeholder="–û–ø–∏—à–∏—Ç–µ –∑–∞–¥–∞—á—É –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å..." />
          <button type="submit">–ò—Å–∫–∞—Ç—å</button>
        </form>
        <div id="searchLinks"></div>
        <iframe id="searchFrame" class="search-frame" src="about:blank" title="–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ø–Ω–¥–µ–∫—Å"></iframe>
        <div class="note">–ï—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤–æ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–º –æ–∫–Ω–µ, –Ω–∞–∂–º–∏—Ç–µ ¬´–û—Ç–∫—Ä—ã—Ç—å –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ¬ª ‚Äî –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —Å–∞–π—Ç—ã –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—é—Ç –≤—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏–µ.</div>
      </div>
      <div class="panel-footer">
        <button id="openExternal">–û—Ç–∫—Ä—ã—Ç—å –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ</button>
      </div>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å: –ü–µ—Ä–µ–≤–æ–¥ —á–µ—Ä–µ–∑ –ò–ò (Pollinations) -->
    <div class="side-panel" id="translatePanel">
      <div class="panel-header">
        <span>–ü–µ—Ä–µ–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞ (ZubrLite)</span>
        <button class="circle-btn" id="closeTranslate" title="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
      </div>
      <div class="panel-body">
        <div class="translate-grid">
          <select id="langFrom" class="translate-select" title="–° —è–∑—ã–∫–∞">
            <option value="ru">–†—É—Å—Å–∫–∏–π</option>
            <option value="be">–ë–µ–ª–æ—Ä—É—Å—Å–∫–∏–π</option>
            <option value="en">–ê–Ω–≥–ª–∏–π—Å–∫–∏–π</option>
            <option value="es">–ò—Å–ø–∞–Ω—Å–∫–∏–π</option>
            <option value="fr">–§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π</option>
            <option value="de">–ù–µ–º–µ—Ü–∫–∏–π</option>
            <option value="it">–ò—Ç–∞–ª—å—è–Ω—Å–∫–∏–π</option>
            <option value="pt">–ü–æ—Ä—Ç—É–≥–∞–ª—å—Å–∫–∏–π</option>
            <option value="zh">–ö–∏—Ç–∞–π—Å–∫–∏–π</option>
            <option value="ja">–Ø–ø–æ–Ω—Å–∫–∏–π</option>
            <option value="ko">–ö–æ—Ä–µ–π—Å–∫–∏–π</option>
            <option value="ar">–ê—Ä–∞–±—Å–∫–∏–π</option>
            <option value="hi">–•–∏–Ω–¥–∏</option>
            <option value="tr">–¢—É—Ä–µ—Ü–∫–∏–π</option>
            <option value="pl">–ü–æ–ª—å—Å–∫–∏–π</option>
            <option value="uk">–£–∫—Ä–∞–∏–Ω—Å–∫–∏–π</option>
          </select>
          <select id="langTo" class="translate-select" title="–ù–∞ —è–∑—ã–∫">
            <option value="ru">–†—É—Å—Å–∫–∏–π</option>
            <option value="be">–ë–µ–ª–æ—Ä—É—Å—Å–∫–∏–π</option>
            <option value="en">–ê–Ω–≥–ª–∏–π—Å–∫–∏–π</option>
            <option value="es">–ò—Å–ø–∞–Ω—Å–∫–∏–π</option>
            <option value="fr">–§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π</option>
            <option value="de">–ù–µ–º–µ—Ü–∫–∏–π</option>
            <option value="it">–ò—Ç–∞–ª—å—è–Ω—Å–∫–∏–π</option>
            <option value="pt">–ü–æ—Ä—Ç—É–≥–∞–ª—å—Å–∫–∏–π</option>
            <option value="zh">–ö–∏—Ç–∞–π—Å–∫–∏–π</option>
            <option value="ja">–Ø–ø–æ–Ω—Å–∫–∏–π</option>
            <option value="ko">–ö–æ—Ä–µ–π—Å–∫–∏–π</option>
            <option value="ar">–ê—Ä–∞–±—Å–∫–∏–π</option>
            <option value="hi">–•–∏–Ω–¥–∏</option>
            <option value="tr">–¢—É—Ä–µ—Ü–∫–∏–π</option>
            <option value="pl">–ü–æ–ª—å—Å–∫–∏–π</option>
            <option value="uk">–£–∫—Ä–∞–∏–Ω—Å–∫–∏–π</option>
          </select>
        </div>
        <textarea id="textFrom" class="translate-text" rows="5" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞..."></textarea>
        <textarea id="textTo" class="translate-text" rows="5" placeholder="–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–µ—Ä–µ–≤–æ–¥–∞..." readonly></textarea>
      </div>
      <div class="panel-footer translate-actions">
        <button id="swapLangs">–ü–æ–º–µ–Ω—è—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è</button>
        <button id="doTranslate">–ü–µ—Ä–µ–≤–µ—Å—Ç–∏ (AI)</button>
      </div>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å: –†–µ–¥–∞–∫—Ç–æ—Ä —Ç–µ–∫—Å—Ç–∞ -->
    <div class="side-panel" id="editorPanel">
      <div class="panel-header">
        <span>–†–µ–¥–∞–∫—Ç–æ—Ä —Ç–µ–∫—Å—Ç–∞ (–º–∏–Ω–∏‚Äë–ø—Ä–æ–µ–∫—Ç)</span>
        <button class="circle-btn" id="closeEditor" title="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
      </div>
      <div class="panel-body">
        <div class="editor-toolbar">
          <button id="addText">–î–æ–±–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç</button>
          <button id="addImageUrl">–ö–∞—Ä—Ç–∏–Ω–∫–∞ –ø–æ URL</button>
          <label>
            –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª
            <input type="file" id="addImageFile" accept="image/*" />
          </label>
          <select id="fontSelect">
            <option value="font-sans">Sans (Arial)</option>
            <option value="font-serif">Serif (Georgia)</option>
            <option value="font-mono">Monospace (Courier)</option>
            <option value="font-roboto">Roboto</option>
            <option value="font-playfair">Playfair</option>
            <option value="font-oswald">Oswald</option>
          </select>
          <input type="color" id="colorPicker" value="#002b5c" />
          <button id="saveProject">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
        <div class="editor-canvas" id="editorCanvas"></div>
        <div class="note">–ü–æ–¥—Å–∫–∞–∑–∫–∞: –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ –±–ª–æ–∫–∏ –∑–∞ –∫—Ä—É–≥–ª—É—é —Ä—É—á–∫—É. –ö–ª–∏–∫ –ø–æ —Ç–µ–∫—Å—Ç—É ‚Äî —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ –∏ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏.</div>
      </div>
      <div class="panel-footer">
        <button id="clearProject">–û—á–∏—Å—Ç–∏—Ç—å</button>
        <button id="loadProject">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–µ</button>
      </div>
    </div>
  </div>

  <script>
    // –î–∞—Ç–∞
    const today = new Date();
    const todayStr = today.toLocaleDateString("ru-RU", { day: "numeric", month: "long", year: "numeric" });
    document.getElementById("today").textContent = todayStr;

    // –ö–ª—é—á–∏ –¥–ª—è localStorage
    const CONSENT_KEY = "cookiesAccepted";
    const CHAT_KEY = "zubrlite_chat_v1";
    const PROJECT_KEY = "zubrlite_project_v1";

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–≥–ª–∞—Å–∏—è
    function getConsent() {
      return localStorage.getItem(CONSENT_KEY);
    }

    // –≠–ª–µ–º–µ–Ω—Ç—ã
    const chatMessages = document.getElementById("chatMessages");
    const userInput = document.getElementById("userInput");
    const sendBtn = document.getElementById("sendBtn");
    const modeSelect = document.getElementById("modeSelect");

    const searchBtn = document.getElementById("searchBtn");
    const searchPanel = document.getElementById("searchPanel");
    const closeSearch = document.getElementById("closeSearch");
    const searchForm = document.getElementById("searchForm");
    const searchQuery = document.getElementById("searchQuery");
    const searchLinks = document.getElementById("searchLinks");
    const searchFrame = document.getElementById("searchFrame");
    const openExternal = document.getElementById("openExternal");

    const translateBtn = document.getElementById("translateBtn");
    const translatePanel = document.getElementById("translatePanel");
    const closeTranslate = document.getElementById("closeTranslate");
    const langFrom = document.getElementById("langFrom");
    const langTo = document.getElementById("langTo");
    const textFrom = document.getElementById("textFrom");
    const textTo = document.getElementById("textTo");
    const swapLangs = document.getElementById("swapLangs");
    const doTranslate = document.getElementById("doTranslate");

    const editorBtn = document.getElementById("editorBtn");
    const editorPanel = document.getElementById("editorPanel");
    const closeEditor = document.getElementById("closeEditor");
    const editorCanvas = document.getElementById("editorCanvas");
    const addText = document.getElementById("addText");
    const addImageUrl = document.getElementById("addImageUrl");
    const addImageFile = document.getElementById("addImageFile");
    const fontSelect = document.getElementById("fontSelect");
    const colorPicker = document.getElementById("colorPicker");
    const saveProject = document.getElementById("saveProject");
    const loadProject = document.getElementById("loadProject");
    const clearProject = document.getElementById("clearProject");

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    function renderWelcome() {
      renderMessage('<div class="pm-title">ZubrLite –∞–∫—Ç–∏–≤–µ–Ω</div>');
      renderMessage(`<p><b>ZubrLite:</b> –ü—Ä–∏–≤–µ—Ç! –Ø ZubrLite. –Ø –≤—Å–µ–≥–¥–∞ –Ω–∞–ø–æ–º–∏–Ω–∞—é, –∫–∞–∫ –º–µ–Ω—è –∑–æ–≤—É—Ç. –°–µ–≥–æ–¥–Ω—è ${todayStr}. –í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º –∏ –∑–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å.</p>`);
    }

    // –†–µ–Ω–¥–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π PM-—Ç–µ–≥–∞
    function renderMessage(html) {
      const transformed = html.replace(/&lt;PM\s*(.*?)\s*PM&gt;/g, (m, p1) => `<div class="pm-title">${p1}</div>`)
                              .replace(/<PM\s*(.*?)\s*PM>/g, (m, p1) => `<div class="pm-title">${p1}</div>`);
      chatMessages.insertAdjacentHTML("beforeend", transformed);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–∞—Ç–∞
    function saveChat() {
      if (getConsent() === 'yes') {
        localStorage.setItem(CHAT_KEY, chatMessages.innerHTML);
      }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–∞
    function loadChat() {
      if (getConsent() === 'yes') {
        const saved = localStorage.getItem(CHAT_KEY);
        if (saved) {
          chatMessages.innerHTML = saved;
          chatMessages.scrollTop = chatMessages.scrollHeight;
          return true;
        }
      }
      return false;
    }

    // –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
    function escapeHtml(str) {
      return str.replace(/[&<>"']/g, s => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
      }[s]));
    }
    function escapeHtmlKeepingPM(str) {
      const blocks = [];
      const marked = str.replace(/<PM[\s\S]*?PM>/g, m => {
        blocks.push(m);
        return `__PM_BLOCK_${blocks.length - 1}__`;
      });
      const safe = escapeHtml(marked);
      return safe.replace(/__PM_BLOCK_(\d+)__/g, (_, i) => blocks[i]);
    }

    // –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –º–æ–¥–µ–ª–∏
    function modeDescription() {
      const map = {
        standard: "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π: –æ—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, —è—Å–Ω–æ –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ.",
        school: "–®–∫–æ–ª—å–Ω—ã–π: –æ–±—ä—è—Å–Ω—è–π –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏, –ø–æ—à–∞–≥–æ–≤–æ, —Å –ø—Ä–∏–º–µ—Ä–æ–º.",
        pro: "–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π: –¥–∞–≤–∞–π —Ç–æ—á–Ω—ã–µ, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ, –≥–ª—É–±–æ–∫–æ –∞—Ä–≥—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã."
      };
      return map[modeSelect.value] || map.standard;
    }
    function buildInstruction(userText) {
      return [
        "–¢—ã ‚Äî ZubrLite. –í—Å–µ–≥–¥–∞ —É–ø–æ–º–∏–Ω–∞–π, —á—Ç–æ —Ç–µ–±—è –∑–æ–≤—É—Ç ZubrLite.",
        `–°–µ–≥–æ–¥–Ω—è—à–Ω—è—è –¥–∞—Ç–∞: ${todayStr}.`,
        "–ï—Å–ª–∏ –≤ –æ—Ç–≤–µ—Ç–µ –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è —Ç–µ–≥ <PM —Ç–µ–∫—Å—Ç PM>, –æ—Ç–æ–±—Ä–∞–∑–∏ –µ–≥–æ –∫–∞–∫ —Å–∏–Ω–∏–π —Ü–∏—Ç–∞—Ç–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫.",
        modeDescription(),
        "–û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º.",
        "–ó–∞–¥–∞—á–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:",
        userText
      ].join("\n");
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Pollinations
    async function pollinationsAsk(promptText) {
      const url = `https://text.pollinations.ai/${encodeURIComponent(promptText)}`;
      const res = await fetch(url);
      return res.text();
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –æ–±—ã—á–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    async function sendMessage() {
      const text = userInput.value.trim();
      if (!text) return;

      renderMessage(`<p><b>–í—ã:</b> ${escapeHtml(text)}</p>`);
      userInput.value = "";

      renderMessage(`<p><b>ZubrLite:</b> –î—É–º–∞—é –Ω–∞–¥ –æ—Ç–≤–µ—Ç–æ–º...</p>`);

      try {
        const payload = buildInstruction(text);
        let answerText = await pollinationsAsk(payload);

        if (!/ZubrLite/i.test(answerText)) {
          answerText = `–Ø ZubrLite. ${answerText}`;
        }
        if (!answerText.includes("<PM")) {
          answerText = `<PM –û—Ç–≤–µ—Ç –æ—Ç ZubrLite PM>\n` + answerText;
        }

        // –£–¥–∞–ª–∏—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
        const lastIndicator = Array.from(chatMessages.querySelectorAll("p")).pop();
        if (lastIndicator && lastIndicator.textContent.includes("–î—É–º–∞—é –Ω–∞–¥ –æ—Ç–≤–µ—Ç–æ–º")) {
          lastIndicator.remove();
        }

        renderMessage(`<p><b>ZubrLite:</b> ${escapeHtmlKeepingPM(answerText)}</p>`);
        saveChat(); // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é, –µ—Å–ª–∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ
      } catch (err) {
        renderMessage(`<p><b>ZubrLite:</b> –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</p>`);
        saveChat();
      }
    }

    sendBtn.addEventListener("click", sendMessage);
    userInput.addEventListener("keypress", e => { if (e.key === "Enter") sendMessage(); });

    // –ü–∞–Ω–µ–ª–∏
    function hideAllPanels() {
      searchPanel.classList.remove("active");
      translatePanel.classList.remove("active");
      editorPanel.classList.remove("active");
    }
    searchBtn.addEventListener("click", () => { hideAllPanels(); searchPanel.classList.toggle("active"); });
    closeSearch.addEventListener("click", () => searchPanel.classList.remove("active"));
    translateBtn.addEventListener("click", () => { hideAllPanels(); translatePanel.classList.toggle("active"); });
    closeTranslate.addEventListener("click", () => translatePanel.classList.remove("active"));
    editorBtn.addEventListener("click", () => { hideAllPanels(); editorPanel.classList.toggle("active"); });
    closeEditor.addEventListener("click", () => editorPanel.classList.remove("active"));

    // –ü–æ–∏—Å–∫ (–Ø–Ω–¥–µ–∫—Å)
    searchForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const q = searchQuery.value.trim();
      if (!q) return;

      const yandexUrl = `https://yandex.com/search/?text=${encodeURIComponent(q)}`;

      renderMessage(`<PM –ü–æ–∏—Å–∫ (ZubrLite) PM>`);
      renderMessage(`<p><b>–í—ã (–ø–æ–∏—Å–∫):</b> ${escapeHtml(q)}</p>`);

      searchFrame.src = yandexUrl;
      searchLinks.innerHTML = `
        <p><a class="result-link" href="${yandexUrl}" target="_blank">–û—Ç–∫—Ä—ã—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ø–Ω–¥–µ–∫—Å –¥–ª—è: ${escapeHtml(q)}</a></p>
        <p class="note">–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: –æ—Ç–∫—Ä–æ–π—Ç–µ —Å—Å—ã–ª–∫—É –≤—ã—à–µ, —á—Ç–æ–±—ã –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å–∞–π—Ç—ã.</p>
      `;
      saveChat();
    });
    openExternal.addEventListener("click", () => {
      const url = searchFrame.src || "https://yandex.com/";
      window.open(url, "_blank");
    });

    // –ü–µ—Ä–µ–≤–æ–¥ —á–µ—Ä–µ–∑ –ò–ò (Pollinations)
    swapLangs.addEventListener("click", () => {
      const from = langFrom.value;
      langFrom.value = langTo.value;
      langTo.value = from;
    });

    function langName(code) {
      const map = {
        ru: "—Ä—É—Å—Å–∫–æ–≥–æ", be: "–±–µ–ª–æ—Ä—É—Å—Å–∫–æ–≥–æ", en: "–∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ", es: "–∏—Å–ø–∞–Ω—Å–∫–æ–≥–æ", fr: "—Ñ—Ä–∞–Ω—Ü—É–∑—Å–∫–æ–≥–æ",
        de: "–Ω–µ–º–µ—Ü–∫–æ–≥–æ", it: "–∏—Ç–∞–ª—å—è–Ω—Å–∫–æ–≥–æ", pt: "–ø–æ—Ä—Ç—É–≥–∞–ª—å—Å–∫–æ–≥–æ", zh: "–∫–∏—Ç–∞–π—Å–∫–æ–≥–æ", ja: "—è–ø–æ–Ω—Å–∫–æ–≥–æ",
        ko: "–∫–æ—Ä–µ–π—Å–∫–æ–≥–æ", ar: "–∞—Ä–∞–±—Å–∫–æ–≥–æ", hi: "—Ö–∏–Ω–¥–∏", tr: "—Ç—É—Ä–µ—Ü–∫–æ–≥–æ", pl: "–ø–æ–ª—å—Å–∫–æ–≥–æ", uk: "—É–∫—Ä–∞–∏–Ω—Å–∫–æ–≥–æ"
      };
      return map[code] || code;
    }
    function langNameTo(code) {
      const map = {
        ru: "—Ä—É—Å—Å–∫–∏–π", be: "–±–µ–ª–æ—Ä—É—Å—Å–∫–∏–π", en: "–∞–Ω–≥–ª–∏–π—Å–∫–∏–π", es: "–∏—Å–ø–∞–Ω—Å–∫–∏–π", fr: "—Ñ—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π",
        de: "–Ω–µ–º–µ—Ü–∫–∏–π", it: "–∏—Ç–∞–ª—å—è–Ω—Å–∫–∏–π", pt: "–ø–æ—Ä—Ç—É–≥–∞–ª—å—Å–∫–∏–π", zh: "–∫–∏—Ç–∞–π—Å–∫–∏–π", ja: "—è–ø–æ–Ω—Å–∫–∏–π",
        ko: "–∫–æ—Ä–µ–π—Å–∫–∏–π", ar: "–∞—Ä–∞–±—Å–∫–∏–π", hi: "—Ö–∏–Ω–¥–∏", tr: "—Ç—É—Ä–µ—Ü–∫–∏–π", pl: "–ø–æ–ª—å—Å–∫–∏–π", uk: "—É–∫—Ä–∞–∏–Ω—Å–∫–∏–π"
      };
      return map[code] || code;
    }

    doTranslate.addEventListener("click", async () => {
      const text = textFrom.value.trim();
      if (!text) return;
      const source = langFrom.value;
      const target = langTo.value;

      // –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –º–æ–¥–µ–ª–∏ –Ω–∞ –ø–µ—Ä–µ–≤–æ–¥
      const translateInstruction = [
        "–¢—ã ‚Äî ZubrLite. –í—Å–µ–≥–¥–∞ —É–ø–æ–º–∏–Ω–∞–π, —á—Ç–æ —Ç–µ–±—è –∑–æ–≤—É—Ç ZubrLite.",
        `–°–µ–≥–æ–¥–Ω—è—à–Ω—è—è –¥–∞—Ç–∞: ${todayStr}.`,
        "–ï—Å–ª–∏ –≤ –æ—Ç–≤–µ—Ç–µ –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è —Ç–µ–≥ <PM —Ç–µ–∫—Å—Ç PM>, –æ—Ç–æ–±—Ä–∞–∑–∏ –µ–≥–æ –∫–∞–∫ —Å–∏–Ω–∏–π —Ü–∏—Ç–∞—Ç–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫.",
        modeDescription(),
        `–ü–µ—Ä–µ–≤–µ–¥–∏ —Ç–µ–∫—Å—Ç —Å ${langName(source)} –Ω–∞ ${langNameTo(target)}. –í–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–≤–æ–¥, –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π.`,
        `<PM –ü–µ—Ä–µ–≤–æ–¥ ZubrLite PM>`,
        text
      ].join("\n");

      renderMessage(`<p><b>ZubrLite:</b> –í—ã–ø–æ–ª–Ω—è—é –ø–µ—Ä–µ–≤–æ–¥ —Å ${langName(source)} –Ω–∞ ${langNameTo(target)}...</p>`);

      try {
        let translated = await pollinationsAsk(translateInstruction);

        if (!/ZubrLite/i.test(translated)) {
          translated = `–Ø ZubrLite. ${translated}`;
        }
        if (!translated.includes("<PM")) {
          translated = `<PM –ü–µ—Ä–µ–≤–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω ZubrLite PM>\n` + translated;
        }

        textTo.value = translated.replace(/<PM[\s\S]*?PM>/g, '').trim();
        renderMessage(`<p><b>ZubrLite:</b> ${escapeHtmlKeepingPM(translated)}</p>`);
        saveChat();
      } catch (e) {
        textTo.value = "–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞.";
        renderMessage(`<p><b>ZubrLite:</b> –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞.</p>`);
        saveChat();
      }
    });

    // ========== –†–µ–¥–∞–∫—Ç–æ—Ä –º–∏–Ω–∏‚Äë–ø—Ä–æ–µ–∫—Ç–∞ ==========
    let blocks = []; // {id, type, x, y, w, h, html, fontClass, color}

    function createBlock({ type = "text", x = 40, y = 40, w = 200, h = 80, html = "–¢–µ–∫—Å—Ç", fontClass = "font-sans", color = "#002b5c", src = "" } = {}) {
      const id = "b_" + Math.random().toString(36).slice(2, 9);
      const el = document.createElement("div");
      el.className = "block " + fontClass;
      el.style.left = x + "px";
      el.style.top = y + "px";
      el.style.width = w + "px";
      el.style.height = h + "px";
      el.style.color = color;
      el.dataset.id = id;
      el.dataset.type = type;

      const handle = document.createElement("div");
      handle.className = "handle";
      handle.textContent = "‚†ø";
      el.appendChild(handle);

      const content = document.createElement("div");
      content.className = "content";
      if (type === "text") {
        content.contentEditable = "true";
        content.innerHTML = html;
      } else if (type === "image") {
        content.innerHTML = `<img src="${src}" alt="image" />`;
      }
      el.appendChild(content);

      // Drag
      let isDragging = false;
      let startX = 0, startY = 0, startLeft = 0, startTop = 0;
      handle.addEventListener("mousedown", (e) => {
        isDragging = true;
        handle.style.cursor = "grabbing";
        startX = e.clientX; startY = e.clientY;
        startLeft = parseInt(el.style.left, 10);
        startTop = parseInt(el.style.top, 10);
        document.addEventListener("mousemove", onMove);
        document.addEventListener("mouseup", onUp);
        e.preventDefault();
      });
      function onMove(e) {
        if (!isDragging) return;
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;
        el.style.left = (startLeft + dx) + "px";
        el.style.top = (startTop + dy) + "px";
      }
      function onUp() {
        isDragging = false;
        handle.style.cursor = "grab";
        document.removeEventListener("mousemove", onMove);
        document.removeEventListener("mouseup", onUp);
      }

      editorCanvas.appendChild(el);
      blocks.push({
        id, type, x, y, w, h,
        html: type === "text" ? content.innerHTML : "",
        src: type === "image" ? src : "",
        fontClass, color
      });
      // Sync on edits
      content.addEventListener("input", () => {
        const b = blocks.find(b => b.id === id);
        if (b) b.html = content.innerHTML;
      });
      return el;
    }

    addText.addEventListener("click", () => {
      createBlock({
        type: "text",
        html: "–ù–æ–≤—ã–π —Ç–µ–∫—Å—Ç",
        fontClass: fontSelect.value,
        color: colorPicker.value,
        x: 50 + Math.random() * 80,
        y: 50 + Math.random() * 80,
        w: 240, h: 90
      });
    });

    addImageUrl.addEventListener("click", () => {
      const url = prompt("–í–≤–µ–¥–∏—Ç–µ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:");
      if (!url) return;
      createBlock({
        type: "image",
        src: url,
        x: 60 + Math.random() * 80,
        y: 60 + Math.random() * 80,
        w: 240, h: 180
      });
    });

    addImageFile.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        createBlock({
          type: "image",
          src: reader.result,
          x: 70 + Math.random() * 80,
          y: 70 + Math.random() * 80,
          w: 260, h: 200
        });
      };
      reader.readAsDataURL(file);
      e.target.value = "";
    });

    // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —à—Ä–∏—Ñ—Ç–∞/—Ü–≤–µ—Ç–∞ –∫ –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–º—É —Ç–µ–∫—Å—Ç–æ–≤–æ–º—É –±–ª–æ–∫—É (–ø–æ –∫–ª–∏–∫—É –≤–Ω—É—Ç—Ä—å).
    let lastFocusedBlockId = null;
    editorCanvas.addEventListener("click", (e) => {
      const blockEl = e.target.closest(".block");
      if (!blockEl) return;
      lastFocusedBlockId = blockEl.dataset.id;
      const b = blocks.find(b => b.id === lastFocusedBlockId);
      if (b && b.type === "text") {
        // –ü—Ä–∏–º–µ–Ω–∏–º —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        blockEl.className = "block " + fontSelect.value;
        blockEl.style.color = colorPicker.value;
        b.fontClass = fontSelect.value;
        b.color = colorPicker.value;
      }
    });

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
    function serializeBlocks() {
      // –û–±–Ω–æ–≤–∏–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏ —Ä–∞–∑–º–µ—Ä—ã –∏–∑ DOM
      blocks = blocks.map(b => {
        const el = editorCanvas.querySelector(`.block[data-id="${b.id}"]`);
        if (!el) return b;
        const rect = el.getBoundingClientRect();
        const parentRect = editorCanvas.getBoundingClientRect();
        const content = el.querySelector(".content");
        return {
          ...b,
          x: parseInt(el.style.left, 10) || (rect.left - parentRect.left),
          y: parseInt(el.style.top, 10) || (rect.top - parentRect.top),
          w: parseInt(el.style.width, 10) || rect.width,
          h: parseInt(el.style.height, 10) || rect.height,
          html: b.type === "text" ? content.innerHTML : b.html
        };
      });
      return blocks;
    }
    function saveToLocal() {
      if (getConsent() !== 'yes') {
        alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ –∏–∑-–∑–∞ –æ—Ç–∫–∞–∑–∞ –≤ —Å–æ–≥–ª–∞—Å–∏–∏ –Ω–∞ cookies.");
        return;
      }
      const data = serializeBlocks();
      localStorage.setItem(PROJECT_KEY, JSON.stringify(data));
      alert("–ü—Ä–æ–µ–∫—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ –±—Ä–∞—É–∑–µ—Ä–µ.");
    }
    function loadFromLocal() {
      if (getConsent() !== 'yes') {
        alert("–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –∏–∑-–∑–∞ –æ—Ç–∫–∞–∑–∞ –≤ —Å–æ–≥–ª–∞—Å–∏–∏ –Ω–∞ cookies.");
        return;
      }
      const raw = localStorage.getItem(PROJECT_KEY);
      if (!raw) { alert("–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö."); return; }
      const data = JSON.parse(raw);
      // –û—á–∏—Å—Ç–∏—Ç—å —Ö–æ–ª—Å—Ç
      editorCanvas.innerHTML = "";
      blocks = [];
      data.forEach(b => {
        const el = createBlock(b);
        el.style.left = b.x + "px";
        el.style.top = b.y + "px";
        el.style.width = b.w + "px";
        el.style.height = b.h + "px";
        el.className = "block " + (b.fontClass || "font-sans");
        el.style.color = b.color || "#002b5c";
        const content = el.querySelector(".content");
        if (b.type === "text") {
          content.innerHTML = b.html || "";
          content.contentEditable = "true";
        } else if (b.type === "image") {
          content.innerHTML = `<img src="${b.src}" alt="image" />`;
        }
      });
    }

    saveProject.addEventListener("click", saveToLocal);
    loadProject.addEventListener("click", loadFromLocal);
    clearProject.addEventListener("click", () => {
      if (confirm("–û—á–∏—Å—Ç–∏—Ç—å —Ö–æ–ª—Å—Ç?")) {
        editorCanvas.innerHTML = "";
        blocks = [];
      }
    });

    // –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
    editorBtn.addEventListener("click", () => {
      if (getConsent() !== 'yes' || !localStorage.getItem(PROJECT_KEY)) return;
      // –ü–æ–¥–≥—Ä—É–∑–∏–º –º–æ–ª—á–∞ –±–µ–∑ –∞–ª–µ—Ä—Ç–æ–≤
      const raw = localStorage.getItem(PROJECT_KEY);
      try {
        const data = JSON.parse(raw);
        editorCanvas.innerHTML = "";
        blocks = [];
        data.forEach(b => {
          const el = createBlock(b);
          el.style.left = b.x + "px";
          el.style.top = b.y + "px";
          el.style.width = b.w + "px";
          el.style.height = b.h + "px";
          el.className = "block " + (b.fontClass || "font-sans");
          el.style.color = b.color || "#002b5c";
          const content = el.querySelector(".content");
          if (b.type === "text") {
            content.innerHTML = b.html || "";
            content.contentEditable = "true";
          } else if (b.type === "image") {
            content.innerHTML = `<img src="${b.src}" alt="image" />`;
          }
        });
      } catch {}
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–≥–ª–∞—Å–∏—è –Ω–∞ cookies
    function showCookieModal() {
      const modal = document.createElement('div');
      modal.id = 'cookieModal';
      modal.innerHTML = `
        <div class="modal-content">
          <h2>–°–æ–≥–ª–∞—Å–∏–µ –Ω–∞ cookies</h2>
          <p>–ú—ã –±—É–¥–µ–º —Å–æ–±–∏—Ä–∞—Ç—å –∏ —Ö—Ä–∞–Ω–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–∞—Å, –µ—Å–ª–∏ –≤—ã –ø—Ä–∏–Ω–∏–º–∞–µ—Ç–µ. –ü—Ä–∏–Ω–∏–º–∞–µ—Ç–µ –ª–∏ –≤—ã?</p>
          <div class="consent-buttons">
            <button class="consent-btn consent-yes" id="consentYes">–î–∞</button>
            <button class="consent-btn consent-no" id="consentNo">–ù–µ—Ç</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      return new Promise((resolve) => {
        const yesBtn = modal.querySelector('#consentYes');
        const noBtn = modal.querySelector('#consentNo');

        yesBtn.addEventListener('click', () => {
          localStorage.setItem(CONSENT_KEY, 'yes');
          modal.remove();
          resolve('yes');
        });

        noBtn.addEventListener('click', () => {
          localStorage.setItem(CONSENT_KEY, 'no');
          // –û—á–∏—Å—Ç–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –æ—Ç–∫–∞–∑–µ
          localStorage.removeItem(CHAT_KEY);
          localStorage.removeItem(PROJECT_KEY);
          modal.remove();
          resolve('no');
        });
      });
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    async function init() {
      const consent = getConsent();
      if (consent === null) {
        await showCookieModal();
      }
      const finalConsent = getConsent();
      if (finalConsent === 'yes') {
        loadChat();
      }
      if (chatMessages.innerHTML.trim() === '') {
        renderWelcome();
      }
    }

    // –ó–∞–ø—É—Å–∫
    init();
  </script>
</body>
</html>
